import{_ as s,o as a,c as n,U as e}from"./chunks/framework.3eb667f5.js";const l="/assets/w1.ca33bfae.webp",p="/assets/w2.eea3d535.webp",o="/assets/w3.73274c82.webp",r="/assets/w4.9be6a1ee.webp",t="/assets/w5.482f0689.webp",c="/assets/w6.ca04d712.webp",i="/assets/w7.af37b648.webp",d="/assets/w8.fc18fcad.webp",C="/assets/w9.48041811.webp",y="/assets/w10.1be1260d.webp",b="/assets/w11.10f1dcda.webp",m="/assets/w12.b38d7d07.webp",u="/assets/w13.1699dcfc.webp",h="/assets/w14.77d88a06.webp",A="/assets/w15.a5bf9187.webp",D="/assets/w16.fe0e19b7.webp",_="/assets/w17.0168e760.webp",w="/assets/w18.393dd17f.webp",g="/assets/w19.982ac349.webp",x=JSON.parse('{"title":"OpenWRT 配置 WireGuard 服务端及客户端配置教程","description":"","frontmatter":{},"headers":[],"relativePath":"life/wg/wg.md","lastUpdated":1681917777000}'),F={name:"life/wg/wg.md"},E=e(`<h1 id="openwrt-配置-wireguard-服务端及客户端配置教程" tabindex="-1">OpenWRT 配置 WireGuard 服务端及客户端配置教程 <a class="header-anchor" href="#openwrt-配置-wireguard-服务端及客户端配置教程" aria-label="Permalink to &quot;OpenWRT 配置 WireGuard 服务端及客户端配置教程&quot;">​</a></h1><h2 id="前言" tabindex="-1">前言 <a class="header-anchor" href="#前言" aria-label="Permalink to &quot;前言&quot;">​</a></h2><p>去年还是前年因为需要访问家里设备在 <strong>OpenWRT</strong>上部署了 <strong>OpenVPN</strong>,主要用于在外方便<code>VPN 回家</code>的使用场景。使用了很长一段时间，在 Windows、macOS、iOS、安卓上体验都非常的稳定。</p><p>而今天的主角是已经火了几年的了<code>WireGuard</code>, 同样是 <strong>VPN 回家服务</strong>,试用了一段时间后决定以后主用 WG 了。(<s>主要是用的固件没有集成OpenVPN，每次升级都要自己重新安装一次太麻烦了</s>)。</p><p>由于 <strong>WireGuard</strong> 在 <strong>Linux</strong> 上安装配置较为麻烦,而很多 <strong>OpenWRT</strong> 固件也都预装了 <strong>WG</strong> ,并且有图形化界面方便设置.所以目前推荐还是在 <strong>OpenWRT</strong> 来直接使用。</p><h2 id="_1、服务端" tabindex="-1">1、服务端 <a class="header-anchor" href="#_1、服务端" aria-label="Permalink to &quot;1、服务端&quot;">​</a></h2><div class="warning custom-block"><p class="custom-block-title">注意</p><p>我的 OpenWRT 是以<strong>旁路由</strong>的形式存在于家庭网络中,<strong>所以后续防火墙设置可能和把 OpenWRT 当主路由的形式不同.</strong></p></div><h3 id="_1-1-创建密钥" tabindex="-1">1.1 创建密钥 <a class="header-anchor" href="#_1-1-创建密钥" aria-label="Permalink to &quot;1.1 创建密钥&quot;">​</a></h3><hr><h4 id="_1-1-1-预共享密钥" tabindex="-1">1.1.1 预共享密钥 <a class="header-anchor" href="#_1-1-1-预共享密钥" aria-label="Permalink to &quot;1.1.1 预共享密钥&quot;">​</a></h4><p>通过<code>SSH</code>登陆到 OpenWRT 后台。</p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">mkdir</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">wg</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 创建目录存放公钥私钥</span></span>
<span class="line"><span style="color:#82AAFF;">cd</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">wg</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 进入文件夹</span></span>
<span class="line"><span style="color:#82AAFF;">umask</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">077</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 配置创建密钥的权限</span></span>
<span class="line"><span style="color:#FFCB6B;">wg</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">genpsk</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">sharekey</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 创建预共享密钥</span></span>
<span class="line"><span style="color:#FFCB6B;">cat</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">sharekey</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 获取密钥复制保存</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><img src="`+l+`" alt="w1"></p><h4 id="_1-1-2-服务端公钥私钥" tabindex="-1">1.1.2 服务端公钥私钥 <a class="header-anchor" href="#_1-1-2-服务端公钥私钥" aria-label="Permalink to &quot;1.1.2 服务端公钥私钥&quot;">​</a></h4><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">wg</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">genkey</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">tee</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">server_privatekey</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">wg</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">pubkey</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">server_publickey</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 创建服务端公钥和私钥</span></span>
<span class="line"><span style="color:#FFCB6B;">cat</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">server_privatekey</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 获取服务端私钥复制保存</span></span>
<span class="line"><span style="color:#FFCB6B;">cat</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">server_publickey</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 获取服务端公钥复制保存</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><img src="`+p+`" alt="w2"></p><h4 id="_1-1-3-客户端公钥私钥-macos" tabindex="-1">1.1.3 客户端公钥私钥 ( macOS ) <a class="header-anchor" href="#_1-1-3-客户端公钥私钥-macos" aria-label="Permalink to &quot;1.1.3 客户端公钥私钥 ( macOS )&quot;">​</a></h4><p><code>重复此操作创建每个客户端的公钥和私钥,请注意修改以下命令中的文件名,本文以 macOS 为例:</code></p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">wg</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">genkey</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">tee</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">macos_privatekey</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">wg</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">pubkey</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">macos_publickey</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 创建 macOS 客户端公钥和私钥</span></span>
<span class="line"><span style="color:#FFCB6B;">cat</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">macos_privatekey</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 获取 macOS 客户端私钥复制保存</span></span>
<span class="line"><span style="color:#FFCB6B;">cat</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">macos_publickey</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 获取 macOS 客户端公钥复制保存</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><img src="`+o+'" alt="w3"></p><h3 id="_1-2-配置-openwrt" tabindex="-1">1.2 配置 OpenWRT <a class="header-anchor" href="#_1-2-配置-openwrt" aria-label="Permalink to &quot;1.2 配置 OpenWRT&quot;">​</a></h3><hr><h4 id="_1-2-1-服务端相关配置" tabindex="-1">1.2.1 服务端相关配置 <a class="header-anchor" href="#_1-2-1-服务端相关配置" aria-label="Permalink to &quot;1.2.1 服务端相关配置&quot;">​</a></h4><p>登陆 OpenWRT – 网络 – 接口 – 添加新接口</p><p><img src="'+r+'" alt="w4"></p><p>填写接口名 – 选择接口协议 – 提交</p><p><img src="'+t+'" alt="w5"></p><p>基本设置 – 填写上文获取的<code>服务端私钥</code> 自行填写一个端口号 – <code>并且在路由器映射该端口的 UDP 协议</code> IP 地址填写一个 VPN 专用的网段 IP – 本文以<code>192.168.100.X</code>为 WireGuard 的专用网段为例,则本 WG 服务器 IP 为<code>192.168.100.1/24</code></p><p><img src="'+c+'" alt="w6"></p><p>防火墙设置 – 选择 vpn</p><p><img src="'+i+'" alt="w7"></p><h4 id="_1-2-2-客户端-peers-区域为每个客户端添加配置" tabindex="-1">1.2.2 客户端 Peers 区域为每个客户端添加配置 <a class="header-anchor" href="#_1-2-2-客户端-peers-区域为每个客户端添加配置" aria-label="Permalink to &quot;1.2.2 客户端 Peers 区域为每个客户端添加配置&quot;">​</a></h4><p>选择<code>预共享密钥</code> – 添加</p><p><img src="'+d+'" alt="w8"></p><p>公钥 – 填写上文获取的<code>macOS 客户端公钥</code> 预共享密钥 – 填写上文获取的<code>预共享密钥</code> 允许的 IP – 即表示为此 macOS 客户端分配固定 IP , 本文示例为 <code>192.168.100.2/32</code> , <strong>注意各客户端 IP 不能冲突</strong>. 持续 Keep-Alive – 填写 25</p><p><img src="'+C+`" alt="w9"></p><h4 id="_1-2-3-防火墙" tabindex="-1">1.2.3 防火墙 <a class="header-anchor" href="#_1-2-3-防火墙" aria-label="Permalink to &quot;1.2.3 防火墙&quot;">​</a></h4><p>网络 – 防火墙 – 自定义防火墙 – 添加以下防火墙 – 重启防火墙</p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">iptables</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-t</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nat</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-A</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">POSTROUTING</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-s</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">192.168.100.0/</span><span style="color:#F78C6C;">24</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-o</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">br-lan</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-j</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">MASQUERADE</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 注意此条防火墙网段 192.168.100.0/24 需和上文服务端 IP 网段保持一致。</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><strong>再次声明我的 OpenWRT 是作为旁路由接入</strong>,此条防火墙不确定适用于主路由部署 WireGuard 使用.主路由用户可以尝试无需设置防火墙(经朋友测试)</p><h4 id="_1-2-4-重启-wireguard" tabindex="-1">1.2.4 重启 WireGuard <a class="header-anchor" href="#_1-2-4-重启-wireguard" aria-label="Permalink to &quot;1.2.4 重启 WireGuard&quot;">​</a></h4><p>返回网络 – 接口 – 关闭 – 连接 或者直接重启整个 OpenWRT 最为稳妥</p><p><img src="`+y+`" alt="w10"></p><h2 id="_2、客户端" tabindex="-1">2、客户端 <a class="header-anchor" href="#_2、客户端" aria-label="Permalink to &quot;2、客户端&quot;">​</a></h2><h3 id="_2-1-创建客户端配置文件" tabindex="-1">2.1 创建客户端配置文件 <a class="header-anchor" href="#_2-1-创建客户端配置文件" aria-label="Permalink to &quot;2.1 创建客户端配置文件&quot;">​</a></h3><p>创建后缀为<code>.conf</code>的配置文件,例如<code>macos_wireguard.conf</code>,复制以下信息,并且修改对应的公私钥信息:</p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">Interface</span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#FFCB6B;">Address</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">192.168.100.2/</span><span style="color:#F78C6C;">32</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 对应 macOS 客户段分配的 IP</span></span>
<span class="line"><span style="color:#FFCB6B;">PrivateKey</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">qJHywBpl27Ao/TRse85DQ/f+kwfNGRmPDYCq0OC6uUY=</span></span>
<span class="line"><span style="color:#FFCB6B;">DNS</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">192.168.1.3</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 本地的 DNS 服务器或者公有 DNS 服务器,例如: 114.114.114.114</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">Peer</span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#FFCB6B;">PublicKey</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">u7vjXN90uJt7pRjG8tR7hb25ssYOi7PRzJ5h9Diy02I=</span></span>
<span class="line"><span style="color:#FFCB6B;">AllowedIPs</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">192.168.1.0/</span><span style="color:#F78C6C;">24</span><span style="color:#C3E88D;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">192.168.100.0/</span><span style="color:#F78C6C;">24</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># macOS 如上设置可与 ClashX Pro 共存仅代理局域网,互联网走本地网络.</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># iPhone iPad 设置为 0.0.0.0/0 全局则模式.</span></span>
<span class="line"><span style="color:#FFCB6B;">PresharedKey</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Pu5xBEBmz9ghhUMNp5o72s+w7nuLwxJJUgNk3EljFVo=</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 预共享密钥</span></span>
<span class="line"><span style="color:#FFCB6B;">Endpoint</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">ddns.xxxxx.com:</span><span style="color:#F78C6C;">12345</span></span>
<span class="line"><span style="color:#FFCB6B;">PersistentKeepalive</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">25</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>此时的配置文件是用于客户端的,所以<code>PrivateKey</code>则为 macOS 客户端的私钥,而<code>Peer</code>中的<code>PublicKey</code>则为 OpenWRT 的公钥.<strong>请注意反向思考</strong>,<code>Endpoint</code>填写家中的 IP 或者 DDNS 域名和端口。</p><h4 id="_2-1-1-allowedips" tabindex="-1">2.1.1 AllowedIPs <a class="header-anchor" href="#_2-1-1-allowedips" aria-label="Permalink to &quot;2.1.1 AllowedIPs&quot;">​</a></h4><p>值得注意的是<code>AllowedIPs</code>参数。针对不同场景和需求,此处可以配置不用的路由。 当此处为<code>0.0.0.0/0</code>时表示任意网络请求都经过 VPN 俗称全局 VPN , 由于 iPhone 同时只能有 1 个 VPN 软件在线,所以当 <code>WireGuard</code> 启动时,其他类似<code>Quanx</code>,<code>小火箭</code>等软件则无法使用,此时 iPhone 可以全局 VPN 使用家中的网络来访问一些外网。</p><p>如果是 macOS 或 Windows 客户端,<code>WireGuard</code>和<code>Clash</code>等软件可以共存,此处可以设置为<code>AllowedIPs = 192.168.1.0/24, 192.168.100.0/24</code>,表示访问内网网段才会走 VPN 。而其他互联网,外网等访问还是走当前网络来利用<code>Clash</code>分流。</p><h3 id="_2-2-macos" tabindex="-1">2.2 macOS <a class="header-anchor" href="#_2-2-macos" aria-label="Permalink to &quot;2.2 macOS&quot;">​</a></h3><p>在 macOS App Store 下载 <code>WireGuard</code>,从文件导入隧道。</p><p><img src="`+b+'" alt="w11"></p><p>选择允许添加 VPN 配置</p><p><img src="'+m+'" alt="w12"></p><p>连接成功</p><p><img src="'+u+'" alt="w13"></p><p>在 OpenWRT 状态页面能够看到连接成功的状态信息</p><p><img src="'+h+'" alt="w14"></p><h3 id="_2-3-ios" tabindex="-1">2.3 iOS <a class="header-anchor" href="#_2-3-ios" aria-label="Permalink to &quot;2.3 iOS&quot;">​</a></h3><p>重复上述操作创建 iPhone 的配置文件,并上传至 iCloud 云盘. 在 iOS 设备 App Store 下载 <code>WireGuard</code></p><img src="'+A+'" alt="w15" style="zoom:30%;"><p>添加隧道 – 导入配置或压缩包</p><img src="'+D+'" alt="w16" style="zoom:33%;"><p>从 iCloud 云盘中选择 iphone_wireguard.conf 配置文件</p><img src="'+_+'" alt="w17" style="zoom:33%;"><p>选择允许添加 VPN 配置</p><img src="'+w+'" alt="w18" style="zoom:33%;"><p>连接成功</p><img src="'+g+'" alt="w19" style="zoom:33%;"><h2 id="结语" tabindex="-1">结语 <a class="header-anchor" href="#结语" aria-label="Permalink to &quot;结语&quot;">​</a></h2><p>本文详细的讲解了在 OpenWRT 上如何配置 WireGuard 以及客户端的安装和配置。</p>',73),P=[E];function f(B,k,O,q,v,W){return a(),n("div",null,P)}const T=s(F,[["render",f]]);export{x as __pageData,T as default};
